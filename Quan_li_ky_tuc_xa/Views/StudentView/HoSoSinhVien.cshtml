@model IEnumerable<Quan_li_ky_tuc_xa.Models.Entities.Hop_dong>

@{
    ViewData["Title"] = "Thông tin phòng ở hiện tại";
    Layout = "~/Views/Shared/Components/Students/StudentViewLayout.cshtml";
}

<div class="templatemo-content">
    <link rel="stylesheet" href="/css/templatemo_main.css" />

    <div class="template-page-wrapper fullwidth">
        <div class="tm-topbox-wrapper">
            <div class="container-fluid">
                <div class="row">


                    <!-- MAIN CONTENT -->
                    <main class="col-md-9 templatemo-content-wrapper" role="main">
                        <ol class="breadcrumb">
                            <li><a href="/Students">Trang chủ</a></li>
                            <li class="active">Thông tin sinh viên</li>
                        </ol>

                        <h3>Phòng đang ở / đã được phân</h3>
                        <p class="text-muted">Danh sách các phòng mà bạn (hoặc hợp đồng liên quan) đang ở. Nhấp <strong>Xem SV</strong> để lọc danh sách sinh viên bên dưới theo phòng.</p>

                        @if (TempData["Error"] != null)
                        {
                            <div class="alert alert-danger">@TempData["Error"]</div>
                        }

                        @* Model là danh sách Hop_dong (các hợp đồng) *@
                        @{
                            var hops = Model ?? Enumerable.Empty<Quan_li_ky_tuc_xa.Models.Entities.Hop_dong>();
                        }

                        @if (!hops.Any())
                        {
                            <div class="alert alert-info">Bạn chưa có phân bổ phòng (không có hợp đồng với trạng thái đang ở / đã duyệt).</div>
                        }
                        else
                        {
                            // Gom nhóm theo MaPhong để hiển thị 1 hàng cho mỗi phòng
                            var roomsGroup = hops
                            .Where(h => !string.IsNullOrEmpty(h.MaPhong))
                            .GroupBy(h => h.MaPhong)
                            .Select(g => new
                            {
                                MaPhong = g.Key,
                                TenPhong = g.FirstOrDefault()?.Phong?.Ten ?? "",
                                Toa = g.FirstOrDefault()?.Phong?.Toa?.Ten ?? "",
                                SoNguoi = g.Count(),
                                HopDongs = g.ToList()
                            })
                            .OrderBy(r => r.MaPhong)
                            .ToList();
                            <div class="panel panel-default">
                                <div class="panel-heading"><strong>Danh sách phòng</strong></div>
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" id="roomsTable">
                                            <thead>
                                                <tr>
                                                    <th>Mã phòng</th>
                                                    <th>Tên phòng</th>
                                                    <th>Tòa</th>
                                                    <th>Số người (trong danh sách)</th>
                                                    <th>Hành động</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var r in roomsGroup)
                                                {
                                                    <tr data-phongid="@r.MaPhong">
                                                        <td>@r.MaPhong</td>
                                                        <td>@r.TenPhong</td>
                                                        <td>@r.Toa</td>
                                                        <td>@r.SoNguoi</td>
                                                        <td>
                                                            <button type="button" class="btn btn-sm btn-primary btn-view-students" data-phongid="@r.MaPhong">
                                                                Xem SV
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-secondary btn-reset-students">
                                                                Hiện tất cả
                                                            </button>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- ================= Student info panel (read-only) ================= -->
                        <div class="panel panel-default" id="studentsPanel">
                            <div class="panel-heading"><strong>Hồ sơ sinh viên nội trú</strong></div>
                            <div class="panel-body">
                                @{
                                    // ViewBag.Students nên là IEnumerable các object có thuộc tính MaSV, HoVaTen, NgaySinh, CCCD, Lop, Khoa, SDT, Email, DiaChi, PhongId
                                    var students = ViewBag.Students as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                                }

                                @if (!students.Any())
                                {
                                    <div class="alert alert-info">Không có dữ liệu hồ sơ sinh viên nội trú để hiển thị.</div>
                                }
                                else
                                {
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-striped table-hover" id="studentsTable">
                                            <thead>
                                                <tr>
                                                    <th>MaSV</th>
                                                    <th>Họ và tên</th>
                                                    <th>Ngày sinh</th>
                                                    <th>CCCD</th>
                                                    <th>Lớp</th>
                                                    <th>Khoa</th>
                                                    <th>SDT</th>
                                                    <th>Email</th>
                                                    <th>Địa chỉ</th>
                                                    <th>Phòng</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var sv in students)
                                                {
                                                    // đọc an toàn các trường (có thể null)
                                                    string phongId = "";
                                                    try { phongId = sv.PhongId ?? ""; } catch { phongId = ""; }

                                                    string ma = "";
                                                    try { ma = sv.MaSV ?? sv.MSSV ?? ""; } catch { ma = ""; }

                                                    string ten = "";
                                                    try { ten = sv.HoVaTen ?? sv.Ten ?? ""; } catch { ten = ""; }

                                                    DateTime? ns = null;
                                                    try { ns = (DateTime?)sv.NgaySinh; } catch { ns = null; }

                                                    string cccd = "";
                                                    try { cccd = sv.CCCD ?? sv.CMND ?? ""; } catch { cccd = ""; }

                                                    string lop = "";
                                                    try { lop = sv.Lop ?? ""; } catch { lop = ""; }

                                                    string khoa = "";
                                                    try { khoa = sv.Khoa ?? ""; } catch { khoa = ""; }

                                                    string sdt = "";
                                                    try { sdt = sv.SDT ?? sv.DienThoai ?? ""; } catch { sdt = ""; }

                                                    string email = "";
                                                    try { email = sv.Email ?? ""; } catch { email = ""; }

                                                    string diachi = "";
                                                    try { diachi = sv.DiaChi ?? sv.Dia_chi ?? ""; } catch { diachi = ""; }
                                                    <tr data-phongid="@phongId">
                                                        <td>@ma</td>
                                                        <td>@ten</td>
                                                        <td>
                                                            @if (ns.HasValue)
                                                            {
                                                                @ns.Value.ToString("dd/MM/yyyy")
                                                            }
                                                            else
                                                            {
                                                                @Html.Raw("&nbsp;")
                                                            }
                                                        </td>
                                                        <td>@cccd</td>
                                                        <td>@lop</td>
                                                        <td>@khoa</td>
                                                        <td>@sdt</td>
                                                        <td>@email</td>
                                                        <td>@diachi</td>
                                                        <td>@phongId</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="text-muted small">Bảng trên chỉ để xem — không thể chỉnh sửa trực tiếp từ trang này. Nhấp <strong>Hiện tất cả</strong> hoặc double-click vùng sinh viên để reset filter.</p>
                                }
                            </div>
                        </div>

                    </main> <!-- /.templatemo-content-wrapper -->

                </div> <!-- /.row -->
            </div> <!-- /.container-fluid -->
        </div> <!-- /.tm-topbox-wrapper -->
    </div> <!-- /.template-page-wrapper -->
</div> <!-- /.templatemo-content -->
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script>
    $(function () {
        // Khi click nút "Xem SV" trên hàng phòng: lọc các dòng sinh viên theo data-phongid
        $(".btn-view-students").on("click", function () {
            var phongId = $(this).data("phongid") + "";
            if (!phongId) {
                $("#studentsTable tbody tr").show();
                return;
            }
            $("#studentsTable tbody tr").each(function () {
                var sid = ($(this).data("phongid") || "") + "";
                if (sid === phongId) {
                    $(this).show().addClass("table-active");
                } else {
                    $(this).hide().removeClass("table-active");
                }
            });

            // cuộn tới panel sinh viên
            $('html, body').animate({ scrollTop: $('#studentsPanel').offset().top - 60 }, 300);
        });

        // Reset filter khi click nút Hiện tất cả
        $(".btn-reset-students").on("click", function () {
            $("#studentsTable tbody tr").show().removeClass("table-active");
            $('html, body').animate({ scrollTop: $('#studentsPanel').offset().top - 60 }, 300);
        });

        // Double-click panel để reset
        $("#studentsPanel").on("dblclick", function () {
            $("#studentsTable tbody tr").show().removeClass("table-active");
        });
    });
</script>
